{
  "avroSchema": {
    "type": "record",
    "name": "message",
    "fields": [
      {
        "name": "META",
        "type": {
          "type": "record",
          "name": "meta",
          "fields": [
            {
              "name": "CHANGES",
              "type": {
                "type": "array",
                "items": [
                  {
                    "type": "record",
                    "name": "change",
                    "fields": [
                      {
                        "name": "FIELD",
                        "type": "string"
                      },
                      {
                        "name": "CHANGE",
                        "type": "string"
                      },
                      {
                        "name": "REASON",
                        "type": "string"
                      }
                    ]
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "name": "DATA",
        "type": {
          "type": "record",
          "name": "data",
          "fields": [
            {
              "name": "NAME",
              "type": [
                "null",
                "string"
              ],
              "default": null
            },
            {
              "name": "ID",
              "type": [
                "null",
                "int"
              ],
              "default": null
            },
            {
              "name": "TIME_WITH_TIMEZONE",
              "type": [
                "null",
                {
                  "type": "long",
                  "logicalType": "time-micros"
                }
              ],
              "default": null
            }
          ]
        }
      }
    ]
  },
  "testCases": [
    {
      "name": "no bad records, some existing changes",
      "records": [
        {
          "meta": {
            "changes": [
              {
                "field": "name",
                "change": "TRUNCATED",
                "reason": "name was ridiculously long"
              }
            ]
          },
          "data": {
            "name": "Bob",
            "id": 1,
            "time_with_timezone": "04:00:00+05:30"
          }
        },
        {
          "meta": {
            "changes": []
          },
          "data": {
            "name": "Alice",
            "id": 2,
            "time_with_timezone": "12:00:00"
          }
        }
      ],
      "expectedOutput": [
        {
          "META": {
            "CHANGES": [
              {
                "FIELD": "name",
                "CHANGE": "TRUNCATED",
                "REASON": "name was ridiculously long"
              }
            ]
          },
          "DATA": {
            "NAME": "Bob",
            "ID": 1,
            "TIME_WITH_TIMEZONE": 81000000000
          }
        },
        {
          "META": {
            "CHANGES": []
          },
          "DATA": {
            "NAME": "Alice",
            "ID": 2,
            "TIME_WITH_TIMEZONE": 43200000000
          }
        }
      ]
    },
    {
      "name": "bad record with empty changes",
      "records": [
        {
          "meta": {
            "changes": []
          },
          "data": {
            "name": [
              "B",
              "o",
              "b"
            ],
            "id": 1,
            "time_with_timezone": "04:00:00.000+05:30"
          }
        },
        {
          "meta": {
            "changes": []
          },
          "data": {
            "name": "Alice",
            "id": 2,
            "time_with_timezone": "12:00:00.000"
          }
        }
      ],
      "expectedOutput": [
          {
              "META": {
                  "CHANGES": [
                      {
                          "FIELD": "name",
                          "CHANGE": "NULLED",
                          "REASON": "Could not evaluate union, field NAME is expected to be one of these: NULL, STRING. If this is a complex type, check if offending field (path: DATA.NAME) adheres to schema: [B, o, b]"
                      }
                  ]
              },
              "DATA": {
                  "NAME": null,
                  "ID": 1,
                  "TIME_WITH_TIMEZONE": 81000000000
              }
          },
          {
              "META": {
                  "CHANGES": []
              },
              "DATA": {
                  "NAME": "Alice",
                  "ID": 2,
                  "TIME_WITH_TIMEZONE": 43200000000
              }
          }
        ]
    },
    {
      "name": "bad record with existing changes",
        "records": [
          {
            "meta": {
              "changes": [
                {
                  "field": "id",
                  "change": "CONVERTED",
                  "reason": "was string"
                }
              ]
            },
            "data": {
              "name": 808,
              "id": 2,
              "time_with_timezone": "04:00:00+05:30"
            }
          },
          {
            "meta": {
              "changes": []
            },
            "data": {
              "name": "Alice",
              "id": 2,
              "time_with_timezone": "12:00:00Z"
            }
          }
        ],
        "expectedOutput": [
            {
                "META": {
                    "CHANGES": [
                        {
                            "FIELD": "id",
                            "CHANGE": "CONVERTED",
                            "REASON": "was string"
                        },
                        {
                            "FIELD": "name",
                            "CHANGE": "NULLED",
                            "REASON": "Could not evaluate union, field NAME is expected to be one of these: NULL, STRING. If this is a complex type, check if offending field (path: DATA.NAME) adheres to schema: 808"
                        }
                    ]
                },
                "DATA": {
                    "NAME": null,
                    "ID": 2,
                    "TIME_WITH_TIMEZONE": 81000000000
                }
            },
            {
                "META": {
                    "CHANGES": []
                },
                "DATA": {
                    "NAME": "Alice",
                    "ID": 2,
                    "TIME_WITH_TIMEZONE": 43200000000
                }
            }
        ]
    },
    {
      "name": "record with malformed timezone",
      "records": [
        {
          "meta": {
            "changes": []
          },
          "data": {
            "name": "Bob",
            "id": 1,
            "time_with_timezone": "04:00:00+05:30"
          }
        },
        {
          "meta": {
            "changes": []
          },
          "data": {
            "name": "Alice",
            "id": 2,
            "time_with_timezone": "12:00:00-3:00"
          }
        }
      ],
      "expectedOutput": [
        {
          "META": {
            "CHANGES": []
          },
          "DATA": {
            "NAME": "Bob",
            "ID": 1,
            "TIME_WITH_TIMEZONE": 81000000000
          }
        },
        {
          "META": {
            "CHANGES": [
              {
                "FIELD": "time_with_timezone",
                "CHANGE": "NULLED",
                "REASON": "Could not evaluate union, field TIME_WITH_TIMEZONE is expected to be one of these: NULL, LONG. If this is a complex type, check if offending field (path: DATA.TIME_WITH_TIMEZONE) adheres to schema: 12:00:00-3:00"
              }
            ]
          },
          "DATA": {
            "NAME": "Alice",
            "ID": 2,
            "TIME_WITH_TIMEZONE": null
          }
        }
      ]
    }
  ]
}